// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  TEACHER
  ADMIN
}

enum ExerciseType {
  INDIVIDUAL
  GROUP
}

enum ReviewType {
  PERSUASIVE
  INTERACTIVE
}

enum RevisionStatus {
  PENDING
  APPROVED
  REJECTED
  FINISHED
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  username    String   @unique
  password    String?  // Optional untuk support Google OAuth
  firstName   String
  lastName    String
  role        UserRole @default(STUDENT)
  avatar      String?
  phoneNumber String?  // No WA
  institution String?  // Institusi
  program     String?  // Prodi
  semester    Int?     // Semester
  province    String?  // Provinsi
  city        String?  // Kota
  googleId    String?  @unique // Google OAuth ID
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  classesAsStudent    ClassStudent[]
  classesAsTeacher    Class[]
  annotations         Annotation[]
  chatMessages        ChatMessage[]
  exerciseSubmissions ExerciseSubmission[]
  exerciseTimers      ExerciseTimer[]
  readingTextTimers   ReadingTextTimer[]
  writingOutlines     WritingOutline[]
  writingDrafts       WritingDraft[]
  peerReviews         PeerReview[]
  revisions           Revision[]
  revisionComments    RevisionComment[]
  finalProducts       FinalProduct[]
  groupMembers        GroupMember[]
  History             History[]

  @@map("users")
}

model Class {
  id          String   @id @default(cuid())
  name        String
  description String?
  code        String   @unique
  teacherId   String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  teacher         User             @relation(fields: [teacherId], references: [id])
  students        ClassStudent[]
  readingTexts    ReadingText[]
  exercises       Exercise[]
  writingOutlines WritingOutline[]
  writingDrafts   WritingDraft[]
  chatMessages    ChatMessage[]
  annotations     Annotation[]
  peerReviews     PeerReview[]
  revisions       Revision[]
  finalProducts   FinalProduct[]
  groups          Group[]
  History         History[]

  @@map("classes")
}

model ClassStudent {
  id        String   @id @default(cuid())
  classId   String
  studentId String
  joinedAt  DateTime @default(now())

  // Relations
  class   Class @relation(fields: [classId], references: [id])
  student User  @relation(fields: [studentId], references: [id])

  @@unique([classId, studentId])
  @@map("class_students")
}

model Group {
  id          String   @id @default(cuid())
  name        String
  description String?
  classId     String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  class        Class          @relation(fields: [classId], references: [id])
  members      GroupMember[]
  readingTexts ReadingText[]

  @@map("groups")
}

model GroupMember {
  id        String   @id @default(cuid())
  groupId   String
  studentId String  // Reference to User (student)
  role      String?  // Optional: 'leader', 'member', etc.
  joinedAt  DateTime @default(now())

  // Relations
  group   Group @relation(fields: [groupId], references: [id])
  student User  @relation(fields: [studentId], references: [id])

  @@unique([groupId, studentId])
  @@map("group_members")
}

model ReadingText {
  id        String   @id @default(cuid())
  title     String
  content   String   @default("") // HTML or empty when using PDF
  pdfUrl    String?  // Optional: when set, display PDF instead of content; annotations work on PDF
  classId   String
  groupId   String?  // Optional - untuk reading text yang dikelompokkan
  timerDuration Int? // Countdown timer in seconds (optional)
  author    String?
  source    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  class       Class        @relation(fields: [classId], references: [id])
  group       Group?       @relation(fields: [groupId], references: [id])
  annotations Annotation[]
  exercises   Exercise[]
  timers      ReadingTextTimer[]

  @@map("reading_texts")
}

model Annotation {
  id            String   @id @default(cuid())
  readingTextId String
  userId        String
  classId       String
  content       String
  selectedText  String?  // Text that was selected/highlighted
  startPos      Int      @default(0)
  endPos        Int      @default(0)
  pageIndex     Int?     // For PDF: 0-based page number
  color         String?
  isPublic      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  readingText ReadingText @relation(fields: [readingTextId], references: [id])
  user        User        @relation(fields: [userId], references: [id])
  class       Class       @relation(fields: [classId], references: [id])
  chatMessages ChatMessage[] // Discussion messages

  @@map("annotations")
}

enum ChatMessageType {
  TEXT
  AUDIO
}

model ChatMessage {
  id            String          @id @default(cuid())
  classId       String
  userId        String
  content       String?
  type          ChatMessageType @default(TEXT)
  audioUrl      String?
  audioDuration Int?
  annotationId  String?  // Optional - untuk discussion annotation
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  class      Class      @relation(fields: [classId], references: [id])
  user       User       @relation(fields: [userId], references: [id])
  annotation Annotation? @relation(fields: [annotationId], references: [id])

  @@map("chat_messages")
}

model Exercise {
  id            String       @id @default(cuid())
  title         String
  description   String?
  content       String
  type          ExerciseType @default(INDIVIDUAL)
  readingTextId String?
  classId       String
  dueDate       DateTime?
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  timerDuration Int?         // Timer in seconds
  autoSubmitOnTimeout Boolean @default(true)

  // Relations
  readingText ReadingText?         @relation(fields: [readingTextId], references: [id])
  class       Class                @relation(fields: [classId], references: [id])
  submissions ExerciseSubmission[]
  timers      ExerciseTimer[]

  @@map("exercises")
}

model ExerciseSubmission {
  id          String   @id @default(cuid())
  exerciseId  String
  userId      String
  answer      String
  score       Float?
  feedback    String?
  submittedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  exercise Exercise @relation(fields: [exerciseId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@unique([exerciseId, userId])
  @@map("exercise_submissions")
}

model ExerciseTimer {
  id              String   @id @default(cuid())
  exerciseId      String
  userId          String
  durationSeconds Int      // Total duration in seconds
  remainingSeconds Int     // Remaining seconds
  endTimestamp    BigInt   // End timestamp in milliseconds
  isPaused        Boolean  @default(false)
  isFinished      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  exercise Exercise @relation(fields: [exerciseId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@unique([exerciseId, userId])
  @@map("exercise_timers")
}

model ReadingTextTimer {
  id              String     @id @default(cuid())
  readingTextId   String
  userId          String
  durationSeconds Int        // Total duration in seconds
  remainingSeconds Int       // Remaining seconds
  endTimestamp    BigInt     // End timestamp in milliseconds
  isPaused        Boolean    @default(false)
  isFinished      Boolean    @default(false)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relations
  readingText ReadingText @relation(fields: [readingTextId], references: [id])
  user        User        @relation(fields: [userId], references: [id])

  @@unique([readingTextId, userId])
  @@map("reading_text_timers")
}

model WritingOutline {
  id        String   @id @default(cuid())
  title     String
  content   String // JSON data for mind map
  userId    String
  classId   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User           @relation(fields: [userId], references: [id])
  class  Class          @relation(fields: [classId], references: [id])
  drafts WritingDraft[]

  @@map("writing_outlines")
}

model WritingDraft {
  id        String   @id @default(cuid())
  title     String
  content   String
  outlineId String?
  userId    String
  classId   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  outline       WritingOutline? @relation(fields: [outlineId], references: [id])
  user          User            @relation(fields: [userId], references: [id])
  class         Class           @relation(fields: [classId], references: [id])
  peerReviews   PeerReview[]
  revisions     Revision[]
  finalProducts FinalProduct[]

  @@map("writing_drafts")
}

model PeerReview {
  id         String     @id @default(cuid())
  draftId    String
  reviewerId String
  classId    String
  type       ReviewType @default(INTERACTIVE)
  comment    String
  rating     Int? // 1-5 scale
  isPositive Boolean    @default(true)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  // Relations
  draft    WritingDraft @relation(fields: [draftId], references: [id])
  reviewer User         @relation(fields: [reviewerId], references: [id])
  class    Class        @relation(fields: [classId], references: [id])

  @@map("peer_reviews")
}

model Revision {
  id        String         @id @default(cuid())
  draftId   String
  userId    String
  classId   String
  status    RevisionStatus @default(PENDING)
  content   String
  feedback  String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  // Relations
  draft    WritingDraft      @relation(fields: [draftId], references: [id])
  user     User              @relation(fields: [userId], references: [id])
  class    Class             @relation(fields: [classId], references: [id])
  comments RevisionComment[]

  @@map("revisions")
}

model RevisionComment {
  id         String   @id @default(cuid())
  revisionId String
  userId     String
  comment    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  revision Revision @relation(fields: [revisionId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@map("revision_comments")
}

model FinalProduct {
  id        String   @id @default(cuid())
  title     String
  content   String
  draftId   String
  userId    String
  classId   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  draft WritingDraft @relation(fields: [draftId], references: [id])
  user  User         @relation(fields: [userId], references: [id])
  class Class        @relation(fields: [classId], references: [id])

  @@map("final_products")
}

model History {
  id        String   @id @default(cuid())
  tableName String
  recordId  String
  action    String // CREATE, UPDATE, DELETE
  oldData   String? // JSON
  newData   String? // JSON
  userId    String?
  classId   String?
  createdAt DateTime @default(now())

  // Relations
  user  User?  @relation(fields: [userId], references: [id])
  class Class? @relation(fields: [classId], references: [id])

  @@map("histories")
}
